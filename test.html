<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แก้ไขบัญชีผู้ใช้</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .edit-form {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .edit-form h2 {
      text-align: center;
    }

    .edit-form label {
      display: block;
      margin-top: 15px;
    }

    .input-full {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .form-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 15px;
    }

    #preview {
      display: block;
      margin-top: 10px;
      max-width: 100px;
      max-height: 100px;
      border-radius: 50%;
      object-fit: cover;
    }

    .edit-form button[type="submit"] {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      background-color: #376ba7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .edit-form button[type="submit"]:hover {
      background-color: #2f5e93;
    }

    .password-btn {
      padding: 10px 16px;
      background-color: #1f89e0;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      height: 40px;
      margin-top: 5px;
    }

    .password-btn:hover {
      background-color: #186cb7;
    }

    /* Modal อยู่กับที่ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 350px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 10000;
    }

    .modal input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .save-btn {
      background: rgb(31, 137, 224);
      color: white;
    }

    .close-btn {
      background: gray;
      color: white;
      margin-left: 10px;
    }
  </style>
</head>

<body>

<div class="edit-form">
  <h2>แก้ไขบัญชีผู้ใช้</h2>
  <form action="/update-account" method="POST" enctype="multipart/form-data">

    <label for="lastname">ชื่อผู้ใช้</label>
    <input type="text" id="lastname" name="lastname" class="input-full" placeholder="ผู้ใช้เดิม">

    <label for="username">เปลี่ยนชื่อผู้ใช้</label>
    <input type="text" id="username" name="username" class="input-full" placeholder="ผู้ใช้ใหม่">

    <label>อัปโหลดรูปโปรไฟล์ / แก้ไขรหัสผ่าน</label>
    <div class="form-row">
      <div style="flex: 1;">
        <input type="file" id="profile-picture" name="profile-picture" class="input-full" accept="image/*">
        <img id="preview" src="#" alt="ภาพตัวอย่าง" style="display: none;">
      </div>
      <button type="button" class="password-btn" onclick="showPasswordModal()">แก้ไขรหัสผ่าน</button>
    </div>

    <button type="submit">บันทึกการเปลี่ยนแปลง</button>
  </form>
</div>

<!-- Modal -->
<div class="modal-overlay" id="passwordModal">
  <div class="modal">
    <h3>เปลี่ยนรหัสผ่าน</h3>
    <input type="password" id="currentPassword" placeholder="รหัสผ่านเดิม">
    <input type="password" id="newPassword" placeholder="รหัสผ่านใหม่">
    <input type="password" id="confirmPassword" placeholder="ยืนยันรหัสใหม่">
    <br>
    <button class="btn save-btn" onclick="changePassword()">บันทึก</button>
    <button class="btn close-btn" onclick="closePasswordModal()">ปิด</button>
  </div>
</div>

<script>
  const fileInput = document.getElementById('profile-picture');
  const preview = document.getElementById('preview');

  fileInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.src = '#';
      preview.style.display = 'none';
    }
  });

  function showPasswordModal() {
    document.getElementById('passwordModal').style.display = 'block';
  }

  function closePasswordModal() {
    document.getElementById('passwordModal').style.display = 'none';
  }

  function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;

    if (current !== "1234567") {
      alert("รหัสผ่านเดิมไม่ถูกต้อง");
      return;
    }

    if (newPass.length < 7) {
      alert("รหัสผ่านใหม่ต้องมีอย่างน้อย 7 ตัวอักษร");
      return;
    }

    if (newPass !== confirm) {
      alert("รหัสใหม่และยืนยันไม่ตรงกัน");
      return;
    }

    alert("เปลี่ยนรหัสผ่านเรียบร้อยแล้ว!");
    closePasswordModal();
  }
</script>

</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
    const supabaseUrl = 'https://ntdzzbkplgjipkbykzmb.supabase.co'; // ใส่ Project URL ของคุณ
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50ZHp6YmtwbGdqaXBrYnlrem1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMTQxMDAsImV4cCI6MjA2MTY5MDEwMH0.yrvXGzujPa5MYi7pK-Cnu3HO_NoPWI92hBJnTqr23_4'; // ใส่ anon key ของคุณ
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>
<script>
  async function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;

    if (newPass.length < 7) {
      alert("รหัสผ่านใหม่ต้องมีอย่างน้อย 7 ตัวอักษร");
      return;
    }

    if (newPass !== confirm) {
      alert("รหัสใหม่และยืนยันไม่ตรงกัน");
      return;
    }

    const user = supabase.auth.getUser(); // รับ user ปัจจุบัน
    const session = await supabase.auth.getSession(); // รับ session (ต้องใช้ token)

    if (!session.data.session) {
      alert("กรุณาเข้าสู่ระบบก่อนเปลี่ยนรหัสผ่าน");
      return;
    }

    // เปลี่ยนรหัสผ่านผ่าน Supabase Auth
    const { error } = await supabase.auth.updateUser({
      password: newPass
    });

    if (error) {
      alert("เปลี่ยนรหัสผ่านล้มเหลว: " + error.message);
    } else {
      alert("เปลี่ยนรหัสผ่านสำเร็จ");
      closePasswordModal();
    }
  }
</script>
 

<script>

  fileInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.src = '#';
      preview.style.display = 'none';
    }
  });

  // ฟังก์ชันอัปโหลดรูปภาพไปยัง Supabase
  async function uploadImage() {
    const file = fileInput.files[0];
    if (!file) {
      alert('กรุณาเลือกไฟล์รูปภาพ');
      return;
    }

    const filePath = `avatars/${file.name}`;
    const { data, error } = await supabase
      .storage
      .from('avatars')
      .upload(filePath, file, {
        cacheControl: '3600',
        upsert: true,
        contentType: file.type,
      });

    if (error) {
      alert('อัปโหลดรูปภาพล้มเหลว: ' + error.message);
    } else {
      alert('อัปโหลดรูปภาพสำเร็จ');
      // แสดง URL ของรูปภาพ
      const publicURL = supabase
        .storage
        .from('avatars')
        .getPublicUrl(filePath).publicURL;
      console.log('URL ของรูปภาพ:', publicURL);
    }
  }
</script>

<script>
  document.querySelector('form').addEventListener('submit', async function (e) {
    e.preventDefault(); // หยุดการส่งฟอร์มแบบดั้งเดิม

    const file = fileInput.files[0];
    const lastname = document.getElementById('lastname').value;
    const username = document.getElementById('username').value;

    const { data: userData, error: userError } = await supabase.auth.getUser();
    const user = userData?.user;

    if (!user) {
      alert("กรุณาเข้าสู่ระบบก่อนอัปเดตข้อมูล");
      return;
    }

    // อัปโหลดรูปหากมีการเลือก
    if (file) {
      let oldFilePath = null;

      if (user.user_metadata.avatar_url) {
        oldFilePath = user.user_metadata.avatar_url.split('/storage/v1/object/public/images/')[1];
        console.log('ไฟล์เก่าที่จะลบ:', oldFilePath);
      }

      const filePath = `avatars/${user.id}-${Date.now()}-${file.name.split('.').pop()}`;
      const { data, error: uploadError } = await supabase.storage
        .from('images')
        .upload(filePath, file, { upsert: true });

      if (uploadError) {
        alert("อัปโหลดรูปไม่สำเร็จ: " + uploadError.message);
        return;
      }

      const { data: urlData } = supabase.storage
        .from('images')
        .getPublicUrl(filePath);

      const imageUrl = urlData.publicUrl;
      console.log('✅ URL หลัง upload:', imageUrl);
      if (!imageUrl) {
      console.error('❌ URL ว่างหรือผิด path ตรวจสอบ filePath:', filePath);
    }
    

    // อัปเดตข้อมูลผู้ใช้ในตาราง profiles (หรือเปลี่ยนตามตารางของคุณ)
    const updates = {};
    // ถ้ามีชื่อใหม่
    if (username) {
      updates.display_name = username;
    }

    // ถ้ามี avatar url ใหม่
    if (imageUrl) {
      updates.avatar_url = imageUrl;
    }

    const { error: updateError } = await supabase.auth.updateUser({
    data: updates
    });

    if (updateError) {
      alert("อัปเดตข้อมูลไม่สำเร็จ: " + updateError.message);
    } else {
      alert("บันทึกข้อมูลสำเร็จ!");
      console.log('✅ ส่ง URL นี้ไปที่ metadata:', imageUrl);
    }
    
    // ลบไฟล์เก่า (ถ้ามี)
    if (oldFilePath) {
      const { error: deleteError } = await supabase.storage.from('images').remove([oldFilePath]);
      if (deleteError) {
        console.error('❌ ลบไฟล์เก่าไม่สำเร็จ:', deleteError);
      } else {
        console.log('✅ ลบไฟล์เก่าเรียบร้อย');
      }
    }


    await supabase.auth.refreshSession();
    const { data: { user: refreshedUser } } = await supabase.auth.getUser();

    console.log('avatar_url ใหม่:', refreshedUser.user_metadata.avatar_url);
  }
})
  

  
</script>
