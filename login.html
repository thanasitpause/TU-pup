<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เข้าสู่ระบบ - TU-PUP</title>
  <!-- ตั้งค่าการโหลดทรัพยากร -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Custom styles -->
  <link href="css/tu-common.css" rel="stylesheet">
  <!-- Tailwind Config & CDN -->
  <script src="js/tailwind-config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // ใช้คอนฟิกจากไฟล์ภายนอก
    tailwind.config = window.tailwindConfig;
  </script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase Config -->
  <script src="js/supabase-config.js"></script>
</head>
<body class="bg-gradient-to-tr from-gray-100 to-gray-50 min-h-screen flex items-center justify-center">
  <!-- Decorative Elements -->
  <div class="fixed top-0 left-0 w-full h-1 tu-gradient"></div>
  <div class="fixed bottom-0 left-0 w-full h-1 tu-gradient"></div>
  
  <div class="container mx-auto px-4 py-8 max-w-md">
    <div class="text-center mb-8">
      <div class="inline-block p-2 rounded-full bg-white shadow-md mb-4">
        <svg class="w-16 h-16 tu-gradient rounded-full p-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM7.07 18.28C7.5 17.38 10.12 16.5 12 16.5C13.88 16.5 16.51 17.38 16.93 18.28C15.57 19.36 13.86 20 12 20C10.14 20 8.43 19.36 7.07 18.28ZM18.36 16.83C16.93 15.09 13.46 14.5 12 14.5C10.54 14.5 7.07 15.09 5.64 16.83C4.62 15.49 4 13.82 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 13.82 19.38 15.49 18.36 16.83ZM12 6C10.06 6 8.5 7.56 8.5 9.5C8.5 11.44 10.06 13 12 13C13.94 13 15.5 11.44 15.5 9.5C15.5 7.56 13.94 6 12 6ZM12 11C11.17 11 10.5 10.33 10.5 9.5C10.5 8.67 11.17 8 12 8C12.83 8 13.5 8.67 13.5 9.5C13.5 10.33 12.83 11 12 11Z" fill="url(#tuGradient)"/>
          <defs>
            <linearGradient id="tuGradient" x1="2" y1="2" x2="22" y2="22" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#E60000"/>
              <stop offset="100%" stop-color="#FFCC00"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <a href="index.html" class="inline-block">
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-tu-red to-tu-yellow">TU-PUP</h1>
      </a>
      <p class="text-gray-600 mt-2">เข้าสู่ระบบเพื่อเริ่มต้นการใช้งาน</p>
    </div>
    
    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 transition-all duration-300 hover:shadow-2xl">
      <!-- Login Form -->
      <form id="login-form" class="space-y-5">
        <div>
          <label for="email" class="block text-gray-700 font-medium mb-2">อีเมล</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <input type="email" id="email" class="w-full pl-10 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-tu-red-300 focus:border-tu-red-300 transition-colors" placeholder="your@email.com" required>
          </div>
        </div>
        
        <div>
          <div class="flex justify-between mb-2">
            <label for="password" class="block text-gray-700 font-medium">รหัสผ่าน</label>
            <a href="#" class="text-sm text-tu-red hover:text-tu-red-600 transition-colors">ลืมรหัสผ่าน?</a>
          </div>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <input type="password" id="password" class="w-full pl-10 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-tu-red-300 focus:border-tu-red-300 transition-colors" placeholder="••••••••" required>
          </div>
        </div>
        
        <div id="error-message" class="hidden p-4 bg-red-50 border-l-4 border-tu-red rounded-lg text-tu-red-700"></div>
        
        <button type="submit" id="login-btn" class="w-full bg-gradient-to-r from-tu-red to-tu-red-600 hover:from-tu-red-600 hover:to-tu-red-700 text-white font-medium py-3 px-4 rounded-xl transition duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg">
          เข้าสู่ระบบ
        </button>
        
        <div class="text-center">
          <p class="text-gray-600">ยังไม่มีบัญชี? <a href="register.html" class="text-tu-red font-medium hover:text-tu-red-600 underline transition-colors">สมัครสมาชิกใหม่</a></p>
        </div>
      </form>
      
      <!-- Divider -->
      <div class="my-6 flex items-center">
        <div class="flex-1 border-t border-gray-300"></div>
        <div class="mx-4 text-gray-500 font-medium">หรือ</div>
        <div class="flex-1 border-t border-gray-300"></div>
      </div>
      
      <!-- Social Login -->
      <button id="google-login-btn" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-xl flex items-center justify-center transition duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-sm hover:shadow">
        <svg viewBox="0 0 24 24" class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        เข้าสู่ระบบด้วย Google
      </button>
      
      <div class="mt-6 text-center">
        <a href="index.html" class="text-gray-600 hover:text-gray-800 transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          กลับไปหน้าหลัก
        </a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // ตรวจสอบว่าล็อกอินแล้วหรือไม่
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        // ถ้าล็อกอินแล้ว ให้ไปหน้าหลัก
        window.location.href = 'index.html';
      }
      
      // ล็อกอินด้วยอีเมลและรหัสผ่าน
      const loginForm = document.getElementById('login-form');
      const errorMessage = document.getElementById('error-message');
      const loginBtn = document.getElementById('login-btn');
      
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        // ปิดปุ่มล็อกอินระหว่างที่กำลังล็อกอิน
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span class="flex justify-center items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>กำลังเข้าสู่ระบบ...</span>';
        errorMessage.classList.add('hidden');
        
        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
          });
          
          if (error) throw error;
          
          // ล็อกอินสำเร็จ ไปหน้าหลัก
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Login error:', error);
          
          // แสดงข้อความผิดพลาด
          let message = '';
          switch (error.message) {
            case 'Invalid login credentials':
              message = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
              break;
            case 'Email not confirmed':
              message = 'กรุณายืนยันอีเมลก่อนเข้าสู่ระบบ';
              break;
            default:
              message = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ: ' + error.message;
          }
          
          errorMessage.textContent = message;
          errorMessage.classList.remove('hidden');
          
          // เปิดปุ่มล็อกอินอีกครั้ง
          loginBtn.disabled = false;
          loginBtn.textContent = 'เข้าสู่ระบบ';
        }
      });
      
      // ล็อกอินด้วย Google
      document.getElementById('google-login-btn').addEventListener('click', async function() {
        try {
          // แสดงข้อความกำลังดำเนินการ
          const errorMessage = document.getElementById('error-message');
          errorMessage.classList.add('hidden');
    
          const redirectUrl = window.location.origin + '/auth-callback.html';

          // เรียกใช้ signInWithOAuth โดยระบุ provider เป็น 'google'
          const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: redirectUrl,
              // ระบุ scopes เพิ่มเติมถ้าต้องการข้อมูลเพิ่มเติมจาก Google
              scopes: 'email profile',
            }
          });
    
          if (error) throw error;
    
          // ถ้าไม่มี error การทำงานจะถูกเปลี่ยนเส้นทางโดยอัตโนมัติไปยัง redirectTo URL
    
        } catch (error) {
          console.error('Google signup error:', error);
          // แสดงข้อความผิดพลาด
          const errorMessage = document.getElementById('error-message');
          errorMessage.textContent = 'เกิดข้อผิดพลาดในการสมัครด้วย Google: ' + error.message;
          errorMessage.classList.remove('hidden');
        }
      });
    });
  </script>
</body>
</html>